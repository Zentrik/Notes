\section{Diffusion equation}
\subsection{Diffusion equation derivation with Fourier's law}
Fourier's law for heat flow is
\begin{align} \label{eq:4.1}
	q = -k \grad{\theta}
\end{align}
where $q$ is the heat flux, $k$ the thermal conductivity and $\theta$ is the temperature.
In a volume $V$, the overall heat energy $Q$ is given by
\begin{align} \label{eq:4.2}
	Q = \int_V c_V \rho \theta \dd{V}
\end{align}
where $c_V$ is the specific heat of the material, $\rho$ is the mass density.
The rate of change due to heat flow is
\begin{align*}
	\dv{Q}{t} = \int_V c_V \rho \pdv{\theta}{t} \dd{V} \tag{$\ast$}
\end{align*}
We will integrate \cref{eq:4.1} over the surface $S = \partial V$, giving
\begin{align*}
	-\dv{Q}{t} = \int_S q \cdot \hat n \dd{S}
\end{align*}
The negative sign is due to the normals facing outwards.
This is exactly
\begin{align*}
	-\dv{Q}{t} = \int_S (-k \grad{\theta}) \cdot \hat n \dd{S} = \int_V -k \laplacian{\theta} \dd{V} \tag{$\dagger$}
\end{align*}
Equating these two forms (($\ast$) and ($\dagger$)) for $\dv{Q}{t}$, we find
\begin{align*}
	\int_V (c_V \rho \pdv{\theta}{t} - k \laplacian{\theta}) \dd{V} = 0
\end{align*}
Since $V$ was arbitrary, the integrand must be zero.
So we have
\begin{align*}
	\pdv{\theta}{t} - \frac{k}{c_V \rho} \laplacian{\theta} = 0
\end{align*}
Let $D = \frac{k}{c_V \rho}$ be the diffusion constant.
Then we have the diffusion equation
\begin{align} \label{eq:4.3}
	\pdv{\theta}{t} - D \laplacian{\theta} = 0
\end{align}

\subsection{Diffusion equation derivation with statistical dynamics}
We can derive this equation in another way, using statistical dynamics.
Gas particles diffuse by scattering every fixed time step $\Delta t$ with probability density function $p(\xi)$ of moving by a displacement $\xi$.
On average, we have
\begin{align*}
	\mathbb{E}[\xi] = \int p(\xi) \xi \dd{\xi} = 0
\end{align*}
since there is no bias the direction in which any given particle is travelling.
Suppose that the probability density function after $N\Delta t$ time is described by $P_{N \Delta t}(x)$.
Then, for the next time step,
\begin{align*}
	P_{(N+1)\Delta t}(x) = \int_{-\infty}^\infty p(\xi) P_{N \Delta t}(x - \xi) \dd{\xi}
\end{align*}
Using the Taylor expansion,
\begin{align*}
	P_{(N+1)\Delta t}(x) & \approx \int_{-\infty}^\infty p(\xi) \qty[P_{N \Delta t}(x) + P_{N \Delta t}'(x)(-\xi) + P_{N \Delta t}''(x)\frac{\xi^2}{2} + \cdots] \dd{\xi} \\
	& \approx P_{N \Delta t}(x) - P_{N \Delta t}'(x) \mathbb{E}[\xi] + P_{N \Delta t}''(x) \frac{\mathbb{E}[\xi^2]}{2} + \cdots \\
	& \approx P_{N \Delta t}(x) + P_{N \Delta t}''(x) \frac{\mathbb{E}[\xi^2]}{2} + \cdots
\end{align*}
since $\int p(\xi) \dd{\xi} = 1$.
Identifying $P_{N \Delta t}(x) = P(x, N\Delta t)$, we can write
\begin{align*}
	P(x, (N+1)\Delta t) - P(x, N \Delta t) = \pdv[2]{x} P(x, N\Delta t) \frac{\mathbb{E}[\xi^2]}{2}
\end{align*}
Assuming that the variance $\mathbb{E}[\xi^2]$\footnote{$\Var X = \mathbb{E}[X^2] - \mathbb{E}[X]^2$ and $\mathbb{E}[X] = 0$.} is equal to $2D \Delta t$, then for small $\Delta t$, we find
\begin{align} \label{eq:4.4}
	\pdv{P}{t} = D \pdv[2]{P}{x}
\end{align}
which is exactly the diffusion equation.

\subsection{Similarity solutions}
The characteristic relation between the variance and time suggests that we seek solutions with a dimensionless parameter.
If we can find a change of variables of the form $\theta(\eta) = \theta(x,t)$, then it will likely be easier to solve.
Consider
\begin{align} \label{eq:4.5}
	\eta \equiv \frac{x}{2\sqrt{Dt}}
\end{align}
Then changing variables in \cref{eq:4.3},
\begin{align*}
	\pdv{\theta}{t} = \pdv{\eta}{t} \pdv{\theta}{\eta} = \frac{-1}{2} \frac{x}{\sqrt{D} t^{3/2}} \theta' = \frac{-1}{2} \frac{\eta}{t} \theta'
\end{align*}
and
\begin{align*}
	D \pdv[2]{\theta}{x} = D \pdv{x} \qty(\pdv{\eta}{x} \pdv{\theta}{\eta}) = D \pdv{x} \qty(\frac{1}{2\sqrt{Dt}} \theta') = \frac{D}{4Dt} \theta'' = \frac{1}{4t} \theta''
\end{align*}
Equating,
\begin{align} \label{eq:4.6}
	\theta'' = -2 \eta \theta'
\end{align}
Let $\psi = \theta'$.
Then
\begin{align*}
	\frac{\psi'}{\psi} = -2\eta \implies \ln \psi = -\eta^2 + \text{constant}
\end{align*}
Then, choosing a constant of $c\frac{2}{\sqrt{\pi}}$,
\begin{align} \label{eq:4.7}
	\psi = c\frac{2}{\sqrt{\pi}} e^{-\eta^2} \implies \theta(\eta) = c\frac{2}{\sqrt{\pi}} \int_0^\eta e^{-u^2} \dd{u} = c \erf(\eta) = c \erf \qty(\frac{x}{2\sqrt{Dt}})
\end{align}
where
\begin{align*}
	\erf(z) = \frac{2}{\sqrt{\pi}} \int_0^z e^{-u^2} \dd{u}
\end{align*}
This describes discontinuous initial conditions that spread over time.

\begingroup
\tikzset{every picture/.style={scale=1}}
\input{figures/HeatEquation2D.tex}
\endgroup

\subsection{Heat conduction in a finite bar}
Suppose we have a bar of length $2L$ with $-L \leq x \leq L$ and initial temperature
\begin{align} \label{eq:4.8}
	\theta(x,0) = H(x) = \begin{cases}
		1 & \text{if } 0 \leq x \leq L \\
		0 & \text{if } -L \leq x < 0
	\end{cases}
\end{align}
with boundary conditions 
\begin{align} \label{eq:4.9}
    \theta(L, t) = 1, \quad \theta(-L, t) = 0.
\end{align}

\subsubsection{Transforming boundary conditions}
Currently the boundary conditions \cref{eq:4.9} are not homogeneous, so Sturm-Liouville theory cannot be used directly.
If we can identify a steady-state solution (time-independent) that reflects the late-time behaviour, then we can turn it into a homogeneous set of boundary conditions.
We will try a solution of the form
\begin{align*}
	\theta_s(x) = Ax + B
\end{align*}
since this certainly satisfies the diffusion equation.
To satisfy the boundary conditions \cref{eq:4.9},
\begin{align*}
	A = \frac{1}{2L};\quad B = \frac{1}{2}
\end{align*}
Hence we have a solution
\begin{align} \label{eq:4.10}
	\theta_s = \frac{x + L}{2L}
\end{align}
We will subtract this solution from our original equation for $\theta$, giving
\begin{align*}
	\hat \theta(x,t) = \theta(x,t) - \theta_s(x)
\end{align*}
with homogeneous boundary conditions
\begin{align*}
	\hat \theta(-L, t) = \hat \theta(L, t) = 0
\end{align*}
and initial conditions
\begin{align} \label{eq:4.11}
	\hat \theta(x,0) = H(x) - \frac{x+L}{2L}
\end{align}

\begin{figure}[h] 
    \centering 
    \includegraphics[height=5cm]{04-transformbcs} 
\end{figure}

\subsubsection{Seperation of variables}
We will now separate variables in the usual way.
We will consider the ansatz
\begin{align} \label{eq:4.12}
	\hat \theta(x,t) = X(x) T(t) \implies X'' = - \lambda X; \dot T = -D \lambda T
\end{align}
The boundary conditions imply $\lambda > 0$ and give the Fourier modes $X(x) = A \cos \sqrt{\lambda} x + B \sin \sqrt{\lambda} x$.
For $\cos \sqrt{\lambda} L = 0$, we require $\sqrt{\lambda_m} = \frac{m \pi}{2L}$ for $m$ odd.
Also, $\sin \sqrt{\lambda} L = 0$ gives $\sqrt{\lambda_n} = \frac{n \pi}{L}$ for $n$ even.
Since $\hat \theta$ is odd due to our initial conditions, we can take
\begin{align*}
	X_n = B_n \sin \frac{n \pi x}{L}; \quad \lambda_n = \frac{n^2 \pi^2}{L^2}
\end{align*}
Substituting $\lambda_n$ into \cref{eq:4.12}, $\dot T = -D \lambda T$, we have
\begin{align*}
	T_n(t) = C_n \exp(-\frac{Dn^2 \pi^2}{L^2} t ).
\end{align*}
In general, the solution is
\begin{align} \label{eq:4.13}
	\hat \theta(x,t) = \sum_{n=1}^\infty b_n \sin \frac{n \pi x}{L} \exp(-\frac{Dn^2 \pi^2}{L^2} t )
\end{align}

\subsection{Particular solution to diffusion equation}
At $t = 0$, we have a pure Fourier sine series.
We can then impose the initial conditions \cref{eq:4.11}, to give
\begin{align*}
	b_n = \frac{1}{L} \int_{-L}^L \hat \phi(x,0) \sin \frac{n \pi x}{L} \dd{x}
\end{align*}
where
\begin{align*}
	\hat\phi(x,0) = H(x) - \frac{x+L}{2L}
\end{align*}
Hence, we can use the half-range sine series and find
\begin{align*}
	b_n = \underbrace{ \frac{2}{L} \int_0^L \qty(H(x) - \frac{1}{2}) \sin \frac{n \pi x}{L} \dd{x} }_{\text{square wave}/2, \ \cref{eq:1.7}} - \underbrace{ \frac{2}{L} \int_0^L \frac{x}{2L} \sin \frac{n \pi x}{L} \dd{x} }_{\text{sawtooth}/2L, \ \cref{eq:1.6}}
\end{align*}
which gives
\begin{align*}
	b_n = \frac{2}{(2m-1)\pi} - \frac{(-1)^{n+1}}{n\pi}
\end{align*}
where $n = 2m - 1$, and the first term vanishes for $n$ even.
For $n$ odd or even, we find the same result
\begin{align*}
	b_n = \frac{1}{n\pi}
\end{align*}
Hence
\begin{align*}
	\hat\theta(x,t) = \sum_{n=1}^\infty \frac{1}{n \pi} \sin \frac{n \pi x}{L} \exp\qty(-D \frac{n^2 \pi^2}{L^2} t)
\end{align*}
For the inhomogeneous boundary conditions,
\begin{align} \label{eq:4.14}
	\theta(x,t) = \frac{x+L}{2L} + \hat\theta(x,t)
\end{align}
The similarity solution $\frac{1}{2}\qty(1 + \erf(\frac{x}{2\sqrt{Dt}}))$, \cref{eq:4.7}, is a good fit for early $t$ (excellent for $t \leq 1$), but it does not necessarily satisfy the boundary conditions, so for large $t$ it is a bad approximation.

Plot with $L = 1$ and $D = 1$
insertpicture